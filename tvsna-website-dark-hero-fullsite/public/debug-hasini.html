<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Hasini - VMSNA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }

        button {
            background: #0ea5a4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        button:hover {
            background: #0c8a89;
        }

        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
        }

        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 6px;
        }

        .error {
            color: #721c24;
            background: #f8d7da;
            padding: 10px;
            border-radius: 6px;
        }

        .warning {
            color: #856404;
            background: #fff3cd;
            padding: 10px;
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <h1>Debug Hasini's Account</h1>

    <div id="loginSection" style="display:none;">
        <p class="warning">You need to login as admin first.</p>
        <button onclick="window.location.href='dashboard.html'">Go to Login</button>
    </div>

    <div id="adminSection" style="display:none;">
        <button onclick="checkHasiniStatus()">Check Hasini's Status</button>
        <button onclick="fixHasini()">Set adminNotified = false</button>
        <button onclick="manualTrigger()">Manually Trigger Notification</button>
    </div>

    <div id="output"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD2kxkY2AWz_M11sHiRQWO2bh9f6wYYTDY",
            authDomain: "vmsna-e9bd0.firebaseapp.com",
            projectId: "vmsna-e9bd0",
            storageBucket: "vmsna-e9bd0.firebasestorage.app",
            messagingSenderId: "713819139883",
            appId: "1:713819139883:web:fb9e8d4f39a9fc36c789c1",
            measurementId: "G-QLMZNM8HJ4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);

        let hasiniDoc = null;
        let hasiniUserId = null;

        const ADMIN_EMAILS = [
            'vikramkanagaraj@gmail.com',
            'vokkaligasangam@gmail.com'
        ];

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                document.getElementById('output').innerHTML = '<p class="warning">‚è≥ Not logged in</p>';
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('adminSection').style.display = 'none';
                return;
            }

            if (!ADMIN_EMAILS.includes(user.email)) {
                document.getElementById('output').innerHTML = '<p class="error">‚ùå Access denied. Admin only. You are logged in as: ' + user.email + '</p>';
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminSection').style.display = 'none';
            } else {
                document.getElementById('output').innerHTML = '<p class="success">‚úÖ Authenticated as admin: ' + user.email + '</p>';
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminSection').style.display = 'block';
                // Auto-check Hasini's status
                setTimeout(() => checkHasiniStatus(), 500);
            }
        });

        window.checkHasiniStatus = async function () {
            const output = document.getElementById('output');
            output.innerHTML = '<p>üîç Checking Hasini\'s account...</p>';

            try {
                // Find Hasini's application
                const q = query(
                    collection(db, 'membershipApplications'),
                    where('email', '==', 'babejascorp28@gmail.com')
                );

                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    output.innerHTML = '<p class="error">‚ùå No application found for babejascorp28@gmail.com</p>';
                    return;
                }

                if (snapshot.size > 1) {
                    output.innerHTML = `<p class="warning">‚ö†Ô∏è Found ${snapshot.size} applications for Hasini!</p>`;
                }

                hasiniDoc = snapshot.docs[0];
                const data = hasiniDoc.data();
                hasiniUserId = data.userId;

                // Get Auth status
                let authStatus = 'Unknown';
                let emailVerified = 'Unknown';
                try {
                    const currentUser = auth.currentUser;
                    if (currentUser && currentUser.uid === hasiniUserId) {
                        emailVerified = currentUser.emailVerified ? '‚úÖ YES' : '‚ùå NO';
                        authStatus = 'Current user is Hasini';
                    } else {
                        authStatus = 'Need to check via backend (requires admin SDK)';
                    }
                } catch (e) {
                    authStatus = 'Error: ' + e.message;
                }

                let html = '<h2>Hasini\'s Firestore Document:</h2>';
                html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';

                html += '<h2>Key Fields:</h2>';
                html += '<ul>';
                html += '<li><strong>Status:</strong> ' + (data.status || 'N/A') + '</li>';
                html += '<li><strong>Admin Notified:</strong> ' + (data.adminNotified !== undefined ? data.adminNotified : '‚ùå FIELD MISSING') + '</li>';
                html += '<li><strong>User ID:</strong> ' + (data.userId || 'N/A') + '</li>';
                html += '<li><strong>Email:</strong> ' + (data.email || 'N/A') + '</li>';
                html += '<li><strong>Submitted At:</strong> ' + (data.submittedAt ? new Date(data.submittedAt.toDate()).toLocaleString() : 'N/A') + '</li>';
                html += '</ul>';

                html += '<h2>Diagnosis:</h2>';
                html += '<ul>';

                if (data.adminNotified === undefined) {
                    html += '<li class="error">‚ùå <strong>PROBLEM:</strong> adminNotified field is missing! This account registered before the field was added.</li>';
                    html += '<li class="warning">üí° <strong>FIX:</strong> Click "Set adminNotified = false" button above</li>';
                } else if (data.adminNotified === true) {
                    html += '<li class="success">‚úÖ Admin has already been notified</li>';
                } else {
                    html += '<li class="warning">‚è≥ adminNotified is false - waiting for scheduled function to check</li>';
                }

                if (data.status !== 'pending') {
                    html += '<li class="warning">‚ö†Ô∏è Status is "' + data.status + '" - scheduled function only checks "pending" applications</li>';
                }

                html += '</ul>';

                output.innerHTML = html;

            } catch (error) {
                console.error('Error:', error);
                output.innerHTML = '<p class="error">‚ùå Error: ' + error.message + '</p>';
            }
        };

        window.fixHasini = async function () {
            if (!hasiniDoc) {
                alert('Please run "Check Hasini\'s Status" first');
                return;
            }

            const output = document.getElementById('output');
            output.innerHTML = '<p>‚öôÔ∏è Updating Hasini\'s account...</p>';

            try {
                await updateDoc(hasiniDoc.ref, {
                    adminNotified: false
                });

                output.innerHTML = '<p class="success">‚úÖ Success! Set adminNotified = false<br><br>The scheduled function will check this within 5 minutes and send the admin notification.</p>';

                // Refresh status
                setTimeout(() => checkHasiniStatus(), 2000);

            } catch (error) {
                console.error('Error:', error);
                output.innerHTML = '<p class="error">‚ùå Error: ' + error.message + '</p>';
            }
        };

        window.manualTrigger = async function () {
            if (!hasiniDoc) {
                alert('Please run "Check Hasini\'s Status" first');
                return;
            }

            const output = document.getElementById('output');
            output.innerHTML = '<p>üìß Manually triggering notification...</p>';

            try {
                // This requires Hasini to be logged in, so we'll simulate by calling the function
                // Note: This won't work perfectly, but it's for debugging

                alert('To manually trigger:\n\n1. Have Hasini login at vmsna.web.app/dashboard.html\n2. Or use the manual-notify.html page\n\nThis will immediately trigger the checkEmailVerification function.');

            } catch (error) {
                console.error('Error:', error);
                output.innerHTML = '<p class="error">‚ùå Error: ' + error.message + '</p>';
            }
        };
    </script>
</body>

</html>