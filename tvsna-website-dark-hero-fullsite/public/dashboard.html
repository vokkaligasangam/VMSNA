<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="responsive.css">
    <title>Member Dashboard — VMSNA</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>

<body>
    <header>
        <nav class="nav">
            <div class="brand" style="display: flex; align-items: center; gap: 12px;"><a href="index.html"
                    style="display: flex; align-items: center;"><img src="assets/img/vokkaligasangam.png"
                        alt="VMSNA Logo" style="height: 100px !important; width: auto; margin: -20px 0;"></a><span
                    style="font-size: 18px; font-weight: 600; white-space: nowrap; margin-right: 32px;">Vokkaliga
                    Mahajana
                    Sangam North America</span></div><button class="toggle" aria-label="Open menu">☰</button>
            <div class="menu">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="chapters.html">Chapters</a></li>
                    <li><a href="events.html">Events</a></li>
                    <li><a href="membership.html">Membership</a></li>
                    <li><a href="donate.html">Donate</a></li>
                    <li><a href="media.html">Media</a></li>
                    <li><a href="help.html">Help</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </div>
        </nav>
    </header>
    <section class='section' style='max-width: 1400px; margin: 0 auto; padding: 48px 24px;'>
        <div style='text-align: center; margin-bottom: 48px;'>
            <h2 class='h2' style='font-size: 36px; margin-bottom: 16px; color: #fff;'>Member Dashboard</h2>
            <p class='lead'
                style='max-width: 800px; margin: 0 auto; font-size: 18px; line-height: 1.8; color: #d6e7f0;'>
                Welcome, <span id='user-name-display'>Member</span>!
            </p>
            <button id='logout-btn'
                style='margin-top: 16px; background: transparent; color: #d9a441; border: 1px solid #d9a441; border-radius: 8px; padding: 10px 24px; font-size: 15px; font-weight: 600; cursor: pointer;'>
                Logout
            </button>
        </div>

        <!-- My Details Section -->
        <div class='tile'
            style='background: #0a1a27; border: 1px solid #143244; border-radius: 12px; padding: 32px; margin-bottom: 32px;'>
            <h3 style='color: #0ea5a4; font-size: 24px; margin-top: 0; margin-bottom: 24px;'>My Profile</h3>
            <div id='user-details-loading' style='text-align: center; padding: 40px; color: #98b3c2;'>
                Loading your details...
            </div>
            <div id='user-details-content' style='display: none;'>
                <div
                    style='display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 24px;'>
                    <div style='background: #07111b; padding: 20px; border-radius: 8px; border: 1px solid #143244;'>
                        <div
                            style='font-size: 13px; color: #98b3c2; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;'>
                            Full Name</div>
                        <div style='font-size: 16px; color: #cfe6f1; font-weight: 500;' id='detail-name'>—</div>
                    </div>
                    <div style='background: #07111b; padding: 20px; border-radius: 8px; border: 1px solid #143244;'>
                        <div
                            style='font-size: 13px; color: #98b3c2; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;'>
                            Email</div>
                        <div style='font-size: 16px; color: #cfe6f1; font-weight: 500;' id='detail-email'>—</div>
                    </div>
                    <div style='background: #07111b; padding: 20px; border-radius: 8px; border: 1px solid #143244;'>
                        <div
                            style='font-size: 13px; color: #98b3c2; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;'>
                            Phone</div>
                        <div style='font-size: 16px; color: #cfe6f1; font-weight: 500;' id='detail-phone'>—</div>
                    </div>
                    <div style='background: #07111b; padding: 20px; border-radius: 8px; border: 1px solid #143244;'>
                        <div
                            style='font-size: 13px; color: #98b3c2; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;'>
                            Profession & Services</div>
                        <div style='font-size: 16px; color: #cfe6f1; font-weight: 500;' id='detail-profession'>—</div>
                    </div>
                    <div style='background: #07111b; padding: 20px; border-radius: 8px; border: 1px solid #143244;'>
                        <div
                            style='font-size: 13px; color: #98b3c2; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;'>
                            LinkedIn/Business/Other URL</div>
                        <div style='font-size: 16px; color: #cfe6f1; font-weight: 500;' id='detail-profile-url'>—</div>
                    </div>
                    <div style='background: #07111b; padding: 20px; border-radius: 8px; border: 1px solid #143244;'>
                        <div
                            style='font-size: 13px; color: #98b3c2; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;'>
                            Native Place (Self)</div>
                        <div style='font-size: 16px; color: #cfe6f1; font-weight: 500;' id='detail-origin-self'>—</div>
                    </div>
                    <div style='background: #07111b; padding: 20px; border-radius: 8px; border: 1px solid #143244;'>
                        <div
                            style='font-size: 13px; color: #98b3c2; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;'>
                            Address</div>
                        <div style='font-size: 16px; color: #cfe6f1; font-weight: 500;' id='detail-address'>—</div>
                    </div>
                </div>
                <div style='display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px;'>
                    <div style='background: #07111b; padding: 20px; border-radius: 8px; border: 1px solid #143244;'>
                        <div
                            style='font-size: 13px; color: #98b3c2; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;'>
                            Spouse Name</div>
                        <div style='font-size: 16px; color: #cfe6f1; font-weight: 500;' id='detail-spouse-name'>—</div>
                    </div>
                    <div style='background: #07111b; padding: 20px; border-radius: 8px; border: 1px solid #143244;'>
                        <div
                            style='font-size: 13px; color: #98b3c2; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;'>
                            Spouse Email</div>
                        <div style='font-size: 16px; color: #cfe6f1; font-weight: 500;' id='detail-spouse-email'>—</div>
                    </div>
                    <div style='background: #07111b; padding: 20px; border-radius: 8px; border: 1px solid #143244;'>
                        <div
                            style='font-size: 13px; color: #98b3c2; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;'>
                            Spouse Phone</div>
                        <div style='font-size: 16px; color: #cfe6f1; font-weight: 500;' id='detail-spouse-phone'>—</div>
                    </div>
                    <div style='background: #07111b; padding: 20px; border-radius: 8px; border: 1px solid #143244;'>
                        <div
                            style='font-size: 13px; color: #98b3c2; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;'>
                            Spouse Profession and Services</div>
                        <div style='font-size: 16px; color: #cfe6f1; font-weight: 500;' id='detail-spouse-profession'>—
                        </div>
                    </div>
                    <div style='background: #07111b; padding: 20px; border-radius: 8px; border: 1px solid #143244;'>
                        <div
                            style='font-size: 13px; color: #98b3c2; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;'>
                            LinkedIn/Business/Other URL (Spouse)</div>
                        <div style='font-size: 16px; color: #cfe6f1; font-weight: 500;' id='detail-spouse-profile-url'>—
                        </div>
                    </div>
                    <div style='background: #07111b; padding: 20px; border-radius: 8px; border: 1px solid #143244;'>
                        <div
                            style='font-size: 13px; color: #98b3c2; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;'>
                            Native Place (Spouse)</div>
                        <div style='font-size: 16px; color: #cfe6f1; font-weight: 500;' id='detail-origin-spouse'>—
                        </div>
                    </div>
                </div>
                <div
                    style='margin-top: 24px; background: #07111b; padding: 20px; border-radius: 8px; border: 1px solid #143244;'>
                    <div
                        style='font-size: 13px; color: #98b3c2; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;'>
                        Children Details</div>
                    <div style='font-size: 16px; color: #cfe6f1; font-weight: 500;' id='detail-children'>—</div>
                </div>
                <div
                    style='margin-top: 24px; background: #0d1f2d; padding: 20px; border-radius: 8px; border: 1px solid #1a3a4f;'>
                    <div
                        style='font-size: 13px; color: #98b3c2; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;'>
                        Directory Privacy</div>
                    <div style='font-size: 16px; color: #cfe6f1; font-weight: 500;' id='detail-privacy'>—</div>
                </div>
                <div style='margin-top: 24px; text-align: center; display: flex; gap: 12px; justify-content: center;'>
                    <button id='edit-profile-btn'
                        style='background: #0ea5a4; color: #072025; border: none; border-radius: 8px; padding: 12px 32px; font-size: 16px; font-weight: 600; cursor: pointer;'>
                        Edit Profile
                    </button>
                    <button id='delete-account-btn'
                        style='background: transparent; color: #e74c3c; border: 1px solid #e74c3c; border-radius: 8px; padding: 12px 32px; font-size: 16px; font-weight: 600; cursor: pointer;'>
                        Delete Account
                    </button>
                </div>
            </div>

            <!-- Edit Profile Form (hidden by default) -->
            <div id='edit-profile-form' style='display: none; margin-top: 24px;'>
                <h4 style='color: #0ea5a4; font-size: 20px; margin-bottom: 20px;'>Edit Your Profile</h4>
                <form id='profile-update-form' style='display: flex; flex-direction: column; gap: 16px;'>
                    <div style='display: flex; flex-direction: column; gap: 8px;'>
                        <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>Full Name</label>
                        <input id='edit-name' name='name' required
                            style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                    </div>
                    <div style='display: flex; flex-direction: column; gap: 8px;'>
                        <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>Native Place (Self)</label>
                        <input id='edit-origin-self' name='origin_self'
                            style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                    </div>
                    <div style='display: flex; flex-direction: column; gap: 8px;'>
                        <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>Spouse Name</label>
                        <input id='edit-spouse-name' name='spouse_name'
                            style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                    </div>
                    <div style='display: flex; flex-direction: column; gap: 8px;'>
                        <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>Native Place (Spouse)</label>
                        <input id='edit-origin-spouse' name='origin_spouse'
                            style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                    </div>
                    <div style='display: flex; flex-direction: column; gap: 8px;'>
                        <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>Email (Verified - Cannot be
                            changed)</label>
                        <div id='edit-email-display'
                            style='background: #0d1f2d; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #98b3c2; font-size: 15px; cursor: not-allowed;'>
                            —
                        </div>
                        <input id='edit-email' name='email' type='hidden'>
                    </div>
                    <div style='display: flex; flex-direction: column; gap: 8px;'>
                        <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>Spouse Email</label>
                        <input id='edit-spouse-email' name='spouse_email' type='email'
                            style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                    </div>
                    <div style='display: flex; flex-direction: column; gap: 8px;'>
                        <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>Children Details</label>
                        <textarea id='edit-children' name='children_details' rows='3'
                            style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px; resize: vertical;'></textarea>
                    </div>
                    <div style='display: flex; flex-direction: column; gap: 8px;'>
                        <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>Street Address</label>
                        <input id='edit-street' name='street' required
                            style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                    </div>
                    <div style='display: flex; gap: 12px;'>
                        <div style='display: flex; flex-direction: column; gap: 8px; flex: 1;'>
                            <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>City</label>
                            <input id='edit-city' name='city' required
                                style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                        </div>
                        <div style='display: flex; flex-direction: column; gap: 8px; flex: 1;'>
                            <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>State</label>
                            <input id='edit-state' name='state' required
                                style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                        </div>
                        <div style='display: flex; flex-direction: column; gap: 8px; flex: 1;'>
                            <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>ZIP Code</label>
                            <input id='edit-zip' name='zip' required
                                style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                        </div>
                    </div>
                    <div style='display: flex; flex-direction: column; gap: 8px;'>
                        <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>Phone</label>
                        <input id='edit-phone' name='phone'
                            style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                    </div>
                    <div style='display: flex; flex-direction: column; gap: 8px;'>
                        <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>Spouse Phone</label>
                        <input id='edit-spouse-phone' name='spouse_phone'
                            style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                    </div>
                    <div style='display: flex; flex-direction: column; gap: 8px;'>
                        <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>Profession and Services
                            Offered for Community</label>
                        <input id='edit-profession' name='profession'
                            style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                    </div>
                    <div style='display: flex; flex-direction: column; gap: 8px;'>
                        <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>LinkedIn/Business/Other
                            URL</label>
                        <input id='edit-profile-url' name='profile_url' type='url'
                            style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                    </div>
                    <div style='display: flex; flex-direction: column; gap: 8px;'>
                        <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>Spouse Profession and Services
                            Offered for Community</label>
                        <input id='edit-spouse-profession' name='spouse_profession'
                            style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                    </div>
                    <div style='display: flex; flex-direction: column; gap: 8px;'>
                        <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>LinkedIn/Business/Other URL
                            (Spouse)</label>
                        <input id='edit-spouse-profile-url' name='spouse_profile_url' type='url'
                            style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                    </div>
                    <div
                        style='background: #0d1f2d; border: 1px solid #1a3a4f; border-radius: 8px; padding: 20px; margin-top: 8px;'>
                        <h4 style='color: #d9a441; font-size: 16px; margin-top: 0; margin-bottom: 12px;'>Directory
                            Privacy Settings</h4>
                        <p style='font-size: 13px; color: #98b3c2; margin-bottom: 16px;'>Choose what information other
                            members can see:</p>
                        <div style='display: flex; flex-direction: column; gap: 12px;'>
                            <label style='display: flex; align-items: center; cursor: pointer;'>
                                <input type='radio' id='privacy-full' name='privacy' value='full'
                                    style='margin-right: 10px; width: 18px; height: 18px; cursor: pointer;'>
                                <span style='color: #cfe6f1; font-size: 15px;'><strong>Full Profile</strong> - Show all
                                    details</span>
                            </label>
                            <label style='display: flex; align-items: center; cursor: pointer;'>
                                <input type='radio' id='privacy-limited' name='privacy' value='limited'
                                    style='margin-right: 10px; width: 18px; height: 18px; cursor: pointer;'>
                                <span style='color: #cfe6f1; font-size: 15px;'><strong>Limited Profile</strong> - Show
                                    only name and state</span>
                            </label>
                        </div>
                    </div>
                    <div style='display: flex; gap: 12px; margin-top: 8px;'>
                        <button type='submit'
                            style='background: #0ea5a4; color: #072025; border: none; border-radius: 8px; padding: 12px 24px; font-size: 16px; font-weight: 600; cursor: pointer; flex: 1;'>
                            Save Changes
                        </button>
                        <button type='button' id='cancel-edit-btn'
                            style='background: transparent; color: #98b3c2; border: 1px solid #143244; border-radius: 8px; padding: 12px 24px; font-size: 16px; font-weight: 600; cursor: pointer; flex: 1;'>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Member Directory Section -->
        <div class='tile' style='background: #0a1a27; border: 1px solid #143244; border-radius: 12px; padding: 32px;'>
            <h3 style='color: #d9a441; font-size: 24px; margin-top: 0; margin-bottom: 24px;'>Member Directory</h3>

            <!-- Search Filters -->
            <div
                style='display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;'>
                <div style='display: flex; flex-direction: column; gap: 8px;'>
                    <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>Search by Name</label>
                    <input id='search-name' placeholder='Enter name...'
                        style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                </div>
                <div style='display: flex; flex-direction: column; gap: 8px;'>
                    <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>Search by State</label>
                    <input id='search-state' placeholder='e.g., CA, TX, NY...'
                        style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                </div>
                <div style='display: flex; flex-direction: column; gap: 8px;'>
                    <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>Search by
                        Profession/Skills</label>
                    <input id='search-profession' placeholder='e.g., Engineer, Doctor...'
                        style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                </div>
                <div style='display: flex; flex-direction: column; gap: 8px;'>
                    <label style='color: #98b3c2; font-size: 14px; font-weight: 600;'>Search by Native Place</label>
                    <input id='search-native' placeholder='e.g., Bangalore, Chennai...'
                        style='background: #07111b; border: 1px solid #143244; border-radius: 8px; padding: 12px; color: #cfe6f1; font-size: 15px;'>
                </div>
            </div>
            <div style='display: flex; gap: 12px; margin-bottom: 24px;'>
                <button id='clear-filters'
                    style='background: transparent; color: #98b3c2; border: 1px solid #143244; border-radius: 8px; padding: 10px 20px; font-size: 14px; font-weight: 600; cursor: pointer;'>
                    Clear All Filters
                </button>
                <div style='flex: 1; display: flex; align-items: center; color: #98b3c2; font-size: 14px;'>
                    <span id='results-count'>—</span>&nbsp;members found
                </div>
            </div>
            <div style='overflow-x: auto;'>
                <table style='width: 100%; border-collapse: collapse;'>
                    <thead>
                        <tr style='border-bottom: 2px solid #143244;'>
                            <th
                                style='color: #a9c3d2; padding: 12px 8px; text-align: left; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;'>
                                Name</th>
                            <th
                                style='color: #a9c3d2; padding: 12px 8px; text-align: left; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;'>
                                Location</th>
                            <th
                                style='color: #a9c3d2; padding: 12px 8px; text-align: left; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;'>
                                Native Place</th>
                            <th
                                style='color: #a9c3d2; padding: 12px 8px; text-align: left; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;'>
                                Profession</th>
                            <th
                                style='color: #a9c3d2; padding: 12px 8px; text-align: left; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;'>
                                LinkedIn/Business</th>
                            <th
                                style='color: #a9c3d2; padding: 12px 8px; text-align: left; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;'>
                                Contact</th>
                        </tr>
                    </thead>
                    <tbody id='dir-body' style='color: #cfe6f1;'></tbody>
                </table>
            </div>
            <div id='dir-loading' style='text-align: center; padding: 40px; color: #98b3c2;'>
                Loading member directory...
            </div>
            <div id='dir-empty' style='display: none; text-align: center; padding: 40px; color: #98b3c2;'>
                No members found in the directory.
            </div>
        </div>
    </section>

    <footer>
        <div class="cols">
            <div><strong>VMSNA</strong><br>A volunteer-run, non-profit community platform.</div>
            <div>
                <h4>Explore</h4><a href="about.html">About</a><br><a href="chapters.html">Chapters</a>
            </div>
            <div>
                <h4>Members</h4><a href="membership.html">Benefits</a><br><a href="donate.html">Donate</a>
            </div>
            <div>
                <h4>Help</h4><a href="help.html">Welfare</a><br><a href="contact.html">Contact</a>
            </div>
        </div>
        <div class="copy">© <span id="year"></span> VMSNA. All rights reserved.</div>
        <script>document.getElementById("year").textContent = new Date().getFullYear();</script>
    </footer>
    <script>document.addEventListener('DOMContentLoaded', function () { const btn = document.querySelector('.nav .toggle'); const menu = document.querySelector('.nav .menu'); if (btn && menu) { btn.addEventListener('click', () => { const isOpen = menu.style.display === 'block'; menu.style.display = isOpen ? 'none' : 'block'; }); } });</script>
</body>

</html>
<script>
    // Dashboard v2.1 - Profile editing with delete account and readonly email
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBtPNMDkpYpWDumVd5srmQR0RSJF9azdBA",
        authDomain: "vmsna-e9bd0.firebaseapp.com",
        projectId: "vmsna-e9bd0",
        storageBucket: "vmsna-e9bd0.firebasestorage.app",
        messagingSenderId: "863778654324",
        appId: "1:863778654324:web:0be4038e6383505f86a921",
        measurementId: "G-GW1V7MS84J"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    (function () {
        let currentUser = null;
        let allMembers = [];

        // Check user's country location
        async function checkUserLocation() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                const country = data.country_code;

                console.log('User country:', country);

                if (country !== 'US' && country !== 'CA') {
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Error checking location:', error);
                // If geolocation check fails, allow access (fail open)
                return true;
            }
        }

        // Check authentication state
        auth.onAuthStateChanged(async user => {
            if (!user) {
                // Not logged in, redirect to membership page
                window.location.href = 'membership.html';
                return;
            }

            // Check if user is accessing from allowed location
            const isAllowedLocation = await checkUserLocation();
            if (!isAllowedLocation) {
                await auth.signOut();
                alert('Access is restricted to users in the United States and Canada only.');
                window.location.href = 'membership.html';
                return;
            }

            currentUser = user;
            document.getElementById('user-name-display').textContent = user.email.split('@')[0];
            loadUserDetails(user.uid);
            loadMemberDirectory();
        });

        // Load current user's details
        async function loadUserDetails(userId) {
            try {
                console.log('Loading details for userId:', userId);
                const snapshot = await db.collection('membershipApplications')
                    .where('userId', '==', userId)
                    .limit(1)
                    .get();

                console.log('Found documents:', snapshot.size);

                if (!snapshot.empty) {
                    const data = snapshot.docs[0].data();
                    const docId = snapshot.docs[0].id;
                    console.log('User data:', data);

                    // Store document ID and data for edit functionality
                    window.currentUserDocId = docId;
                    window.currentUserData = data;

                    document.getElementById('detail-name').textContent = data.name || '—';
                    document.getElementById('detail-email').textContent = data.email || '—';
                    document.getElementById('detail-phone').textContent = data.phone || '—';
                    document.getElementById('detail-profession').textContent = data.profession || '—';

                    // Display profile URL as clickable link
                    const profileUrlEl = document.getElementById('detail-profile-url');
                    if (data.profileUrl) {
                        profileUrlEl.innerHTML = `<a href="${data.profileUrl}" target="_blank" style="color: #0ea5a4; text-decoration: none;">${data.profileUrl}</a>`;
                    } else {
                        profileUrlEl.textContent = '—';
                    }

                    document.getElementById('detail-origin-self').textContent = data.nativePlaceSelf || '—';
                    document.getElementById('detail-spouse-name').textContent = data.spouseName || '—';
                    document.getElementById('detail-spouse-email').textContent = data.spouseEmail || '—';
                    document.getElementById('detail-spouse-phone').textContent = data.spousePhone || '—';
                    document.getElementById('detail-spouse-profession').textContent = data.spouseProfession || '—';

                    // Display spouse profile URL as clickable link
                    const spouseProfileUrlEl = document.getElementById('detail-spouse-profile-url');
                    if (data.spouseProfileUrl) {
                        spouseProfileUrlEl.innerHTML = `<a href="${data.spouseProfileUrl}" target="_blank" style="color: #0ea5a4; text-decoration: none;">${data.spouseProfileUrl}</a>`;
                    } else {
                        spouseProfileUrlEl.textContent = '—';
                    }

                    document.getElementById('detail-origin-spouse').textContent = data.nativePlaceSpouse || '—';
                    document.getElementById('detail-children').textContent = data.childrenDetails || '—';

                    // Format address
                    const addressParts = [data.street, data.city, data.state, data.zip].filter(Boolean);
                    document.getElementById('detail-address').textContent = addressParts.join(', ') || '—';

                    // Display privacy setting
                    const privacyText = data.privacyLevel === 'limited' ? 'Limited Profile (Name & State only)' : 'Full Profile (All details visible)';
                    document.getElementById('detail-privacy').textContent = privacyText;

                    // Update user name display if available
                    if (data.name) {
                        document.getElementById('user-name-display').textContent = data.name;
                    }
                } else {
                    console.warn('No membership application found for this user');
                    document.getElementById('user-details-loading').innerHTML = '<span style="color: #f39c12;">No membership application found. Your data may still be processing.</span>';
                }

                document.getElementById('user-details-loading').style.display = 'none';
                document.getElementById('user-details-content').style.display = 'block';
            } catch (error) {
                console.error('Error loading user details:', error);
                document.getElementById('user-details-loading').innerHTML = '<span style="color: #e74c3c;">Error: ' + error.message + '</span>';
            }
        }

        // Load member directory
        async function loadMemberDirectory() {
            try {
                console.log('Loading member directory...');
                // Remove the orderBy to avoid needing a composite index
                const snapshot = await db.collection('membershipApplications')
                    .where('status', '==', 'pending')
                    .get();

                console.log('Found members:', snapshot.size);
                allMembers = [];

                // Track unique emails to prevent duplicates
                const uniqueEmails = new Map(); // email -> member data
                const registeredEmails = new Set();

                // First pass: collect unique members by email (most recent submission wins)
                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    if (data.email && data.userId) {
                        const emailKey = data.email.toLowerCase().trim();
                        registeredEmails.add(emailKey);

                        // Only add if this email hasn't been added yet, or if this is a more recent submission
                        const existing = uniqueEmails.get(emailKey);
                        if (!existing || (data.submittedAt && existing.submittedAt && data.submittedAt.toMillis() > existing.submittedAt.toMillis())) {
                            uniqueEmails.set(emailKey, { id: doc.id, ...data });
                        }
                    }
                }

                // Add unique members to allMembers array
                for (const member of uniqueEmails.values()) {
                    allMembers.push(member);

                    // Check if spouse has email and doesn't have their own account
                    if (member.spouseEmail && member.spouseEmail.trim() !== '') {
                        const spouseEmailLower = member.spouseEmail.toLowerCase().trim();
                        if (!registeredEmails.has(spouseEmailLower)) {
                            // Add spouse as a separate entry with a special flag
                            allMembers.push({
                                id: member.id + '_spouse',
                                name: member.spouseName || 'Spouse of ' + (member.name || 'Member'),
                                email: member.spouseEmail,
                                phone: member.spousePhone,
                                profession: member.spouseProfession || '—',
                                profileUrl: member.spouseProfileUrl,
                                nativePlaceSelf: member.nativePlaceSpouse,
                                street: member.street,
                                city: member.city,
                                state: member.state,
                                zip: member.zip,
                                privacyLevel: member.privacyLevel, // Inherit privacy level from main member
                                isSpouseEntry: true,
                                linkedToMember: member.name
                            });
                        }
                    }
                }

                // Sort in memory instead of in the query
                allMembers.sort((a, b) => {
                    const nameA = (a.name || '').toLowerCase();
                    const nameB = (b.name || '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });

                renderMembers(allMembers);

                document.getElementById('dir-loading').style.display = 'none';

                if (allMembers.length === 0) {
                    document.getElementById('dir-empty').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading member directory:', error);
                document.getElementById('dir-loading').innerHTML = '<span style="color: #e74c3c;">Error: ' + error.message + '</span>';
            }
        }

        // Render members table
        function renderMembers(list) {
            const dirBody = document.getElementById('dir-body');
            const resultsCount = document.getElementById('results-count');

            resultsCount.textContent = list.length;

            if (list.length === 0) {
                dirBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #98b3c2;">No members match your search criteria.</td></tr>';
                return;
            }

            dirBody.innerHTML = list.map(m => {
                // Check privacy level - default to 'full' if not set
                const privacyLevel = m.privacyLevel || 'full';

                if (privacyLevel === 'limited') {
                    // Limited profile: only show name and state
                    return `<tr style="border-bottom: 1px solid #143244;">
                      <td style="padding: 16px 8px; font-size: 15px;">${m.name || '—'}</td>
                      <td style="padding: 16px 8px; font-size: 15px;">${m.state || '—'}</td>
                      <td style="padding: 16px 8px; font-size: 15px; color: #98b3c2; font-style: italic;">Private</td>
                      <td style="padding: 16px 8px; font-size: 15px; color: #98b3c2; font-style: italic;">Limited Profile</td>
                      <td style="padding: 16px 8px; font-size: 15px; color: #98b3c2; font-style: italic;">Private</td>
                      <td style="padding: 16px 8px; font-size: 15px; color: #98b3c2; font-style: italic;">Private</td>
                    </tr>`;
                } else {
                    // Full profile: show all details
                    const location = [m.city, m.state].filter(Boolean).join(', ') || '—';
                    const nativePlace = m.nativePlaceSelf || '—';
                    const contactParts = [];
                    if (m.email) contactParts.push(`<a href="mailto:${m.email}" style="color: #0ea5a4; text-decoration: none;">${m.email}</a>`);
                    if (m.phone) contactParts.push(m.phone);
                    const contact = contactParts.join(' • ') || '—';

                    // Format profile URL as clickable link
                    const profileUrlDisplay = m.profileUrl ?
                        `<a href="${m.profileUrl}" target="_blank" style="color: #0ea5a4; text-decoration: none;">View Profile</a>` :
                        '—';

                    return `<tr style="border-bottom: 1px solid #143244;">
                      <td style="padding: 16px 8px; font-size: 15px;">${m.name || '—'}</td>
                      <td style="padding: 16px 8px; font-size: 15px;">${location}</td>
                      <td style="padding: 16px 8px; font-size: 15px;">${nativePlace}</td>
                      <td style="padding: 16px 8px; font-size: 15px;">${m.profession || '—'}</td>
                      <td style="padding: 16px 8px; font-size: 15px;">${profileUrlDisplay}</td>
                      <td style="padding: 16px 8px; font-size: 15px;">${contact}</td>
                    </tr>`;
                }
            }).join('');
        }

        // Advanced search functionality
        function performSearch() {
            const searchName = document.getElementById('search-name').value.toLowerCase().trim();
            const searchState = document.getElementById('search-state').value.toLowerCase().trim();
            const searchProfession = document.getElementById('search-profession').value.toLowerCase().trim();
            const searchNative = document.getElementById('search-native').value.toLowerCase().trim();

            const filtered = allMembers.filter(m => {
                const matchesName = !searchName || (m.name || '').toLowerCase().includes(searchName);
                const matchesState = !searchState || (m.state || '').toLowerCase().includes(searchState);
                const matchesProfession = !searchProfession || (m.profession || '').toLowerCase().includes(searchProfession);

                // For native place search, only match the relevant native place for the person
                let matchesNative = true;
                if (searchNative) {
                    if (m.isSpouseEntry) {
                        // For spouse entries, only check their own native place (stored in nativePlaceSelf)
                        matchesNative = (m.nativePlaceSelf || '').toLowerCase().includes(searchNative);
                    } else {
                        // For primary members, only check their own native place (nativePlaceSelf)
                        matchesNative = (m.nativePlaceSelf || '').toLowerCase().includes(searchNative);
                    }
                }

                return matchesName && matchesState && matchesProfession && matchesNative;
            });

            renderMembers(filtered);
        }

        // Attach search listeners
        document.getElementById('search-name').addEventListener('input', performSearch);
        document.getElementById('search-state').addEventListener('input', performSearch);
        document.getElementById('search-profession').addEventListener('input', performSearch);
        document.getElementById('search-native').addEventListener('input', performSearch);

        // Clear filters
        document.getElementById('clear-filters').addEventListener('click', () => {
            document.getElementById('search-name').value = '';
            document.getElementById('search-state').value = '';
            document.getElementById('search-profession').value = '';
            document.getElementById('search-native').value = '';
            renderMembers(allMembers);
        });

        // Edit Profile functionality
        document.getElementById('edit-profile-btn').addEventListener('click', function () {
            const userData = window.currentUserData;
            if (!userData) {
                alert('Unable to load profile data. Please refresh the page.');
                return;
            }

            // Pre-populate form fields
            document.getElementById('edit-name').value = userData.name || '';
            document.getElementById('edit-origin-self').value = userData.nativePlaceSelf || '';
            document.getElementById('edit-spouse-name').value = userData.spouseName || '';
            document.getElementById('edit-origin-spouse').value = userData.nativePlaceSpouse || '';

            // Set email value and ensure it remains readonly
            const emailField = document.getElementById('edit-email');
            const emailDisplay = document.getElementById('edit-email-display');
            emailField.value = userData.email || '';
            emailDisplay.textContent = userData.email || '—';

            document.getElementById('edit-spouse-email').value = userData.spouseEmail || '';
            document.getElementById('edit-children').value = userData.childrenDetails || '';
            document.getElementById('edit-street').value = userData.street || '';
            document.getElementById('edit-city').value = userData.city || '';
            document.getElementById('edit-state').value = userData.state || '';
            document.getElementById('edit-zip').value = userData.zip || '';
            document.getElementById('edit-phone').value = userData.phone || '';
            document.getElementById('edit-spouse-phone').value = userData.spousePhone || '';
            document.getElementById('edit-profession').value = userData.profession || '';
            document.getElementById('edit-profile-url').value = userData.profileUrl || '';
            document.getElementById('edit-spouse-profession').value = userData.spouseProfession || '';
            document.getElementById('edit-spouse-profile-url').value = userData.spouseProfileUrl || '';

            // Set privacy radio button
            if (userData.privacyLevel === 'limited') {
                document.getElementById('privacy-limited').checked = true;
            } else {
                document.getElementById('privacy-full').checked = true;
            }

            // Hide profile display, show edit form
            document.getElementById('user-details-content').style.display = 'none';
            document.getElementById('edit-profile-form').style.display = 'block';
        });

        // Cancel edit
        document.getElementById('cancel-edit-btn').addEventListener('click', function () {
            document.getElementById('user-details-content').style.display = 'block';
            document.getElementById('edit-profile-form').style.display = 'none';
        });

        // Handle form submission
        document.getElementById('profile-update-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const updatedData = {
                name: formData.get('name'),
                nativePlaceSelf: formData.get('origin_self'),
                spouseName: formData.get('spouse_name'),
                nativePlaceSpouse: formData.get('origin_spouse'),
                // email is read-only and not updated
                spouseEmail: formData.get('spouse_email'),
                childrenDetails: formData.get('children_details'),
                street: formData.get('street'),
                city: formData.get('city'),
                state: formData.get('state'),
                zip: formData.get('zip'),
                phone: formData.get('phone'),
                spousePhone: formData.get('spouse_phone'),
                profession: formData.get('profession'),
                profileUrl: formData.get('profile_url'),
                spouseProfession: formData.get('spouse_profession'),
                spouseProfileUrl: formData.get('spouse_profile_url'),
                privacyLevel: formData.get('privacy')
            };

            const docId = window.currentUserDocId;
            if (!docId) {
                alert('Error: Unable to update profile. Please refresh and try again.');
                return;
            }

            try {
                // Update Firestore
                await db.collection('membershipApplications').doc(docId).update(updatedData);

                alert('Profile updated successfully!');

                // Reload user data and member directory
                if (currentUser) {
                    await loadUserDetails(currentUser.uid);
                    await loadMemberDirectory();
                }

                // Hide form, show profile
                document.getElementById('user-details-content').style.display = 'block';
                document.getElementById('edit-profile-form').style.display = 'none';
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Failed to update profile: ' + error.message);
            }
        });

        // Delete Account functionality
        document.getElementById('delete-account-btn').addEventListener('click', async () => {
            const confirmMessage = 'Are you sure you want to delete your account?\n\nThis will permanently delete:\n• Your membership application data\n• Your authentication account\n• All your personal information\n\nThis action cannot be undone!';

            if (!confirm(confirmMessage)) {
                return;
            }

            const finalConfirm = prompt('To confirm deletion, please type DELETE in capital letters:');
            if (finalConfirm !== 'DELETE') {
                alert('Account deletion cancelled.');
                return;
            }

            // Get current user
            const user = firebase.auth().currentUser;

            if (!user) {
                alert('Error: No authenticated user found. Please log out and log back in.');
                return;
            }

            try {
                // Query Firestore to find the user's document
                const snapshot = await db.collection('membershipApplications')
                    .where('userId', '==', user.uid)
                    .limit(1)
                    .get();

                if (snapshot.empty) {
                    alert('Error: No membership data found. Your authentication account will still be deleted.');
                    // Delete authentication account even if no Firestore data
                    await user.delete();
                    alert('Authentication account deleted. Redirecting to home page.');
                    window.location.href = 'index.html';
                    return;
                }

                const docId = snapshot.docs[0].id;
                console.log('Deleting document:', docId, 'for user:', user.uid);

                // Delete Firestore document first
                await db.collection('membershipApplications').doc(docId).delete();
                console.log('Firestore document deleted');

                // Delete Firebase Authentication user
                await user.delete();
                console.log('Authentication account deleted');

                alert('Your account has been permanently deleted. You will now be redirected to the home page.');
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error deleting account:', error);

                if (error.code === 'auth/requires-recent-login') {
                    alert('For security reasons, please log out and log back in, then try deleting your account again.');
                    await auth.signOut();
                    window.location.href = 'membership.html';
                } else {
                    alert('Failed to delete account: ' + error.message);
                }
            }
        });

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await auth.signOut();
                window.location.href = 'membership.html';
            } catch (error) {
                console.error('Error logging out:', error);
                alert('Error logging out. Please try again.');
            }
        });
    })();
</script>